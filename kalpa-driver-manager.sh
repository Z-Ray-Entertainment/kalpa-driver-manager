#!/usr/bin/bash

TITLE="Kalpa Driver Manager"
NVIDIA_VENDOR_ID="0x10de"
NVIDIA_GPU_CLASSES=("0x030000" "0x030200") # "desktop_gpu" "mobile_gpu"
PCI_DEVICE_PATH="/sys/bus/pci/devices/"

supported_driver_series="none"
found_nvidia_device="none"
found_nvidia_gpu_but_device_id_does_not_match_support_matrix=false
user_agreed_to_license=false

#G0: Unsupproted
#G6-closed: G06 driver with closed module
#G06-open: G06 driver with open module
#G07: G07 driver there is ust the open module
declare -A GPU_SUPPORT_MATRIX=(
    ["G05"]="0x12b9;0x12ba;0x11be;0x11fc;0x11b6;0x11b7;0x11b8;0x11bc;0x11bd;0x11af;0x11a8;0x0ff8;0x0ffb;0x0ffc;0x0ff6;0x11b9;0x1290;0x1299;0x129a;0x1291;0x1292;0x1293;0x1294;0x1295;0x1296;0x1298;0x11e2;0x11e3;0x11e0;0x11e1;0x119f;0x11a0;0x11a1;0x11a2;0x1199;0x119a;0x119d;0x119e;0x11a3;0x11a7;0x11a9;0x0fe8;0x0fe9;0x0fd9;0x0fdf;0x0fe0;0x0fe1;0x0fe2;0x0fd1;0x0fd2;0x0fd3;0x0fd4;0x0fd5;0x0fd8;0x0fea;0x0fec;0x0fed;0x0fee;0x0fe3;0x0fe4;0x0fcd;0x0fce;0x1198;0x0fdb;0x0fd6;0x11e7;0x11fa;0x11bf;0x11ba;0x11bb;0x11b0;0x11b1;0x11b4;0x118f;0x1194;0x103a;0x103c;0x1022;0x118a;0x118b;0x118d;0x101e;0x101f;0x1020;0x1021;0x0fff;0x102d;0x1024;0x1026;0x1028;0x0ff9;0x0ffa;0x0ffe;0x0ff2;0x0ff3;0x0ff5;0x0ff7;0x0fef;0x0fe7;0x102e;0x102f;0x1023;0x1029;0x102a;0x1027;0x103f;0x1003;0x1004;0x1005;0x1007;0x1008;0x1286;0x1289;0x1280;0x1281;0x1282;0x1284;0x11c7;0x11c8;0x11cb;0x11c3;0x11c4;0x11c5;0x11c6;0x11c0;0x11c2;0x1191;0x1193;0x118e;0x1186;0x1184;0x1185;0x1187;0x1195;0x1188;0x1189;0x118c;0x1180;0x1182;0x1183;0x0ffd;0x0ff1;0x0fe5;0x0fe6;0x0fc5;0x0fc6;0x0fc8;0x0fc9;0x0fc0;0x0fc1;0x0fc2;0x1287;0x1288;0x128b;0x100c;0x1001;0x100a;0x128a;0x128c;0x12a0"
    ["G06-closed"]="0x1436;0x13fb;0x13f8;0x13f9;0x13fa;0x13b1;0x13b2;0x13b3;0x13b4;0x13b6;0x13b0;0x137a;0x137b;0x1667;0x174d;0x174e;0x1617;0x1618;0x1619;0x161a;0x1427;0x13d7;0x13d8;0x13d9;0x13da;0x1398;0x1399;0x139a;0x139b;0x139c;0x139d;0x1390;0x1391;0x1392;0x1393;0x134d;0x134e;0x134f;0x137d;0x1344;0x1346;0x1347;0x1348;0x1349;0x134b;0x1340;0x1341;0x17f0;0x17f1;0x17fd;0x1789;0x1430;0x1431;0x13f1;0x13f2;0x13f3;0x13e7;0x13f0;0x13ba;0x13bb;0x13bc;0x13bd;0x13b9;0x1389;0x17c2;0x17c8;0x179c;0x1401;0x1402;0x1406;0x1407;0x1404;0x13c0;0x13c2;0x1381;0x1382;0x1380;0x13c1;0x13c3;0x1d34;0x1d33;0x1cbc;0x1cbd;0x1cba;0x1cbb;0x1bb5;0x1bb6;0x1bb7;0x1bb8;0x1bb9;0x1bbb;0x1d10;0x1d11;0x1d12;0x1d13;0x1d16;0x1c92;0x1c94;0x1c96;0x1c8c;0x1c8d;0x1c8f;0x1c90;0x1c91;0x1c21;0x1c22;0x1c23;0x1c35;0x1c20;0x1ba0;0x1ba1;0x1ba2;0x1be0;0x1be1;0x1d52;0x1d56;0x1ccc;0x1ccd;0x1c60;0x1c61;0x1c62;0x1c8e;0x1c2d;0x1baa;0x1ba9;0x1cfa;0x1cfb;0x1cb6;0x1cb1;0x1cb2;0x1cb3;0x1c30;0x1c31;0x1bb0;0x1bb1;0x1bb3;0x1bb4;0x1b39;0x15f9;0x15f0;0x15f7;0x15f8;0x1b30;0x1b38;0x15f1;0x1c70;0x1ca7;0x1ca8;0x1caa;0x1b70;0x1b78;0x1d01;0x1d02;0x1c83;0x1c81;0x1c82;0x1c36;0x1c03;0x1c04;0x1c06;0x1c07;0x1c09;0x1bc7;0x1bad;0x1b83;0x1b84;0x1b87;0x1c02;0x1b80;0x1b81;0x1b82;0x1b02;0x1b06;0x1b07;0x1af1;0x1b00;0x1b01;0x1b04;0x1725;0x172e;0x172f;0x1c00;0x1c01;0x1df0;0x1df2;0x1df5;0x1df6;0x1db4;0x1db5;0x1db6;0x1db7;0x1db8;0x1dba;0x1db1;0x1db2;0x1db3;0x1dbe;0x1d81"
    ["G06-open"]="0x1ff9;0x1fb8;0x1fb9;0x1fb6;0x1fb7;0x1fbc;0x1fbb;0x1fba;0x1fb0;0x1fb2;0x1f76;0x1f36;0x1ef5;0x1eb5;0x1eb6;0x21d1;0x1fd9;0x1fdd;0x1f55;0x1f50;0x1f51;0x1f54;0x1ed3;0x1ed0;0x1ed1;0x2191;0x2192;0x1f9f;0x1fa0;0x1f98;0x1f9c;0x1f9d;0x1f92;0x1f94;0x1f95;0x1f96;0x1f97;0x1f10;0x1f11;0x1f12;0x1f14;0x1f15;0x1f91;0x1eae;0x1e90;0x1e91;0x1e93;0x1f99;0x1fa1;0x1f2e;0x1eab;0x1ff0;0x1ff2;0x1fb1;0x1eb8;0x1eba;0x1eb4;0x1eb0;0x1eb1;0x1e37;0x1e38;0x1e78;0x1e30;0x1e36;0x21ae;0x21bf;0x1fbf;0x1fae;0x1eb9;0x1ebe;0x1e3c;0x1e3d;0x1e3e;0x21c4;0x2188;0x2189;0x2182;0x2184;0x2187;0x1f82;0x1f83;0x1f42;0x1f47;0x1f0b;0x1f06;0x1f07;0x1f08;0x1f09;0x1f0a;0x1f02;0x1f03;0x1ec2;0x1ec7;0x1e84;0x1e87;0x1e89;0x1e81;0x1e82;0x1e04;0x1e07;0x1e2d;0x1e2e;0x1e09;0x1e02;0x1e03;0x1f04;0x21c2;0x2183;0x1f81;0x233d;0x2342;0x2345;0x2336;0x2324;0x2330;0x2331;0x2337;0x2339;0x233a;0x2313;0x2322;0x2321;0x2343;0x2302;0x25bb;0x25b9;0x25ba;0x25bc;0x25bd;0x25b5;0x25b8;0x24b8;0x24b9;0x24ba;0x24bb;0x2438;0x24b6;0x24b7;0x25e0;0x25e2;0x25e5;0x25a6;0x25a7;0x25a9;0x25aa;0x2563;0x25a0;0x2561;0x2560;0x2523;0x2521;0x25a2;0x25a5;0x25ab;0x2420;0x249c;0x249d;0x24dd;0x24dc;0x2520;0x24e0;0x2460;0x24df;0x24a4;0x249f;0x25ac;0x25ec;0x25b6;0x24b0;0x24b1;0x2232;0x2233;0x2238;0x2235;0x2236;0x2237;0x2230;0x2231;0x20b6;0x20b7;0x223f;0x25fa;0x25fb;0x25ad;0x25af;0x2531;0x2571;0x2544;0x2582;0x2583;0x2501;0x2503;0x24c7;0x24c8;0x24c9;0x24bf;0x2482;0x2484;0x2486;0x2487;0x2488;0x2414;0x25a4;0x25a3;0x2483;0x25f9;0x25ed;0x2508;0x2507;0x2509;0x252f;0x2504;0x24ad;0x24af;0x24a0;0x24ac;0x2489;0x248a;0x24fa;0x2207;0x2204;0x2205;0x2206;0x2208;0x2505;0x220a;0x222b;0x222f;0x220d;0x2216;0x2203;0x20f1;0x20f2;0x20f3;0x20f5;0x20f6;0x20fd;0x20be;0x20bf;0x20f0;0x20bb;0x20c2;0x20b8;0x20b9;0x20b5;0x20b0;0x2082;0x20b3;0x20b1;0x20b2;0x20ff;0x20fe;0x20c0;0x20b4;0x2081;0x2200"
    ["G07"]="" # Driver not yet in repos. As soon as this is wired up Turing and newer goes here eg. G06-open
)

enroll_mok(){
    echo "MOK enrolement not implemented yet"
}

# Scanns all PCI devices for vendor nvidia
# If nvidia devices found checks if it is of type GPU
# If it is a nvidia GPU check if it is supported accrording to the support matrix
detect_nvidia_gpu_and_supported_driver(){
    for device in $PCI_DEVICE_PATH*; do
        vendor_id=$(cat ${device}/vendor)
        if [ $vendor_id == $NVIDIA_VENDOR_ID ]; then
            device_class=$(cat ${device}/class)
            for nvidia_gpu_class in ${NVIDIA_GPU_CLASSES[@]}; do
                if [ $device_class == $nvidia_gpu_class ]; then
                    found_nvidia_device=$(cat ${device}/device)
                    for driver_series in ${!GPU_SUPPORT_MATRIX[@]}; do
                        IFS=";" read -r -a supported_gpus_by_driver <<< "${GPU_SUPPORT_MATRIX[$driver_series]}"
                        for gpu_id in ${supported_gpus_by_driver[@]}; do
                            if [ $gpu_id == $found_nvidia_device ]; then
                                supported_driver_series=$driver_series
                                echo "Found supported driver series: $supported_driver_series for device $found_nvidia_device"
                            fi
                        done
                    done
                fi
            done
        fi
    done
}

detect_kdialog(){
    if command -v kdialog >/dev/null 2>&1; then
        has_kdialog=true
    else
        if command -v zenity >/dev/null 2>&1; then
            zenity --error --title "$TITLE" --text "KDialog not found. This tool is to be used on Kalpa Desktop. You probably are running Aeon Desktop which is not supported by this utility"
        else
            echo "No supported dialog software found. Exiting"
        fi
        exit 1
    fi

}

analyze_system(){
    # Is Kalpa Dekstop and / or MicroOS: No - Inform user, then Quit
    # Has nVidia GPU: No - Infomr user, then Quit
    # Has supported nVidia GPU: No - Inform user, then Quit
    # Is nvidia GPU supported by open kernel module: No - Check SecureBoot
    #   Has SecureBoot enabled: Yes - Add this script with --mok to autostart to enroll MOK on next system start, inform user
    #   Has SecureBoot enabled: No - Skip MOK enrollment
    detect_kdialog
    detect_nvidia_gpu_and_supported_driver
}

user_consent(){
    kdialog --title "$TITLE" --msgbox "This tool will setup and install the propriatary nVidia driver. This driver is not developed by Kalpa and using it is on your own risk.\n\nBy continuing you agree to the NVIDIA Driver License Agreement to be found here: https://www.nvidia.com/en-us/drivers/nvidia-license/linux/"

    if kdialog --title "$TITLE" --yesno "Do you accept the NVIDIA Driver License Agreement?"; then
        user_agreed_to_license=true
    fi
}

do_install(){
    if kdialog --title "$TITLE" --yesno "Kalpa will install driver series $supported_driver_series for your device $found_nvidia_device"; then
        echo "Do install.."
    fi
}

read_commandline(){
    for i in "$@"; do
        case $i in
            -m*|--mok*)
            analyze_system
            enroll_mok
            ;;
            *)
                    # Unknonw option
            ;;
        esac
    done
}

main(){
    analyze_system

    if [ $found_nvidia_device == "none" ]; then
        kdialog --title "$TITLE" --sorry "Kalpa was unable to detect any NVIDIA graphics device in this computer."
    else
        user_consent
        if [ $user_agreed_to_license = true ]; then
            case $supported_driver_series in
                "G03"|"G04"|"G05")
                    kdialog --title "$TITLE" --sorry "Kalpa detected an NVIDIA GPU (Device ID: $found_nvidia_device) but it is not considered to deliver a good experience. If you believe this to be a mistake please check your graphics card at: https://www.nvidia.com/en-us/drivers/. If the minimum suported driver series is 500 or newer please report this issue to Kalpa Desktop."
                ;;
                "none")
                    if kdialog --title "$TITLE" --yesno "Kalpa detected a NVIDIA GPU (Device ID: $found_nvidia_device) but couldn't match it with any supported driver series. We will try to install the latest driver. Do you want to continue?"; then
                        supported_driver_series="G06-open"
                        do_install
                    fi
                ;;
                *)
                    do_install
                ;;
            esac
        fi
    fi
}

if [ "$#" -eq 0 ]; then
    main
else
    read_commandline $@
fi